<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SorATa - Edit Profile</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        :root {
            --primary-purple: #b14ac2;
            --dark-purple: #9a3aad;
            --light-purple: #c973d6;
            --white: #ffffff;
        }

        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }

        .purple-bg {
            background-color: var(--primary-purple);
        }

        .sorata-title {
            font-family: "Times New Roman", Times, serif;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .feature-card {
            background-color: var(--white);
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="purple-bg text-white shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <span class="sorata-title text-3xl">SorATa</span>
            </div>
            <div class="hidden md:flex space-x-6">
                <a href="cloud-project.html" class="hover:text-purple-200">Home</a>
                <a href="services.html" class="hover:text-purple-200">Services</a>
                <a href="ews-certificate.html" class="hover:text-purple-200">EWS Support</a>
                <a href="crowdfunding.html" class="hover:text-purple-200">Crowdfunding</a>

                <a href="contact.html" class="hover:text-purple-200">Help</a>
                <a href="dashboard.html" class="hover:text-purple-200 font-bold">Dashboard</a>
            </div>
            <div>
                <button id="logout-btn" class="text-white hover:text-purple-200">Logout</button>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="purple-bg text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <h1 class="sorata-title text-4xl mb-4">Edit Profile</h1>
            <p class="text-xl max-w-2xl mx-auto">
                Update your personal information and preferences
            </p>
        </div>
    </section>

    <!-- Edit Profile Form -->
    <section class="py-12">
        <div class="container mx-auto px-4">
            <div class="max-w-2xl mx-auto">
                <div class="feature-card p-8">
                    <h2 class="text-2xl font-bold mb-6" style="color: #9a3aad;">Personal Information</h2>
                    
                    <form id="edit-profile-form" class="space-y-6">
                        <div>
                            <label class="block text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="full-name" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Email</label>
                            <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" readonly>
                            <p class="text-sm text-gray-500 mt-1">Email cannot be changed</p>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Phone Number</label>
                            <input type="tel" id="phone" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Date of Birth</label>
                            <input type="date" id="dob" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Address</label>
                            <textarea id="address" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Emergency Contact</label>
                            <input type="tel" id="emergency-contact" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Blood Group</label>
                            <select id="blood-group" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-gray-700 mb-2">Medical Conditions</label>
                            <textarea id="medical-conditions" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="List any medical conditions, allergies, or medications"></textarea>
                        </div>
                        
                        <div class="flex justify-between pt-4">
                            <a href="dashboard.html" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">Cancel</a>
                            <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <script>
        const supabaseUrl = "https://mauejpnslpzrpsganhsv.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1hdWVqcG5zbHB6cnBzZ2FuaHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDExMDkxNzYsImV4cCI6MjA1NjY4NTE3Nn0.HCOHqRpcCDVhSS8yF0IulIw3QHw6CAQAh1T-XaACkp4";
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Check if user is logged in
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) {
            window.location.href = 'login.html';
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Load user profile
            loadUserProfile();
            
            // Setup form submission
            document.getElementById('edit-profile-form').addEventListener('submit', handleProfileUpdate);
            
            // Setup logout button
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });

        // Load user profile
        async function loadUserProfile() {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        // Profile doesn't exist yet, create it
                        const { data: newProfile, error: createError } = await supabase
                            .from('profiles')
                            .insert([
                                {
                                    id: user.id,
                                    email: user.email,
                                    full_name: user.user_metadata?.full_name || '',
                                    created_at: new Date().toISOString(),
                                    updated_at: new Date().toISOString()
                                }
                            ])
                            .select()
                            .single();
                        
                        if (createError) throw createError;
                        data = newProfile;
                    } else {
                        throw error;
                    }
                }
                
                if (data) {
                    // Populate form fields with user data
                    document.getElementById('full-name').value = data.full_name || '';
                    document.getElementById('email').value = data.email || '';
                    document.getElementById('phone').value = data.phone || '';
                    
                    // Populate additional fields if they exist
                    if (data.dob) document.getElementById('dob').value = data.dob;
                    if (data.address) document.getElementById('address').value = data.address;
                    if (data.emergency_contact) document.getElementById('emergency-contact').value = data.emergency_contact;
                    if (data.blood_group) document.getElementById('blood-group').value = data.blood_group;
                    if (data.medical_conditions) document.getElementById('medical-conditions').value = data.medical_conditions;
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                alert('Unable to load your profile. Please try refreshing the page. If the problem persists, contact support.');
            }
        }

        // Handle profile update
        async function handleProfileUpdate(e) {
            e.preventDefault();
            
            try {
                // Format the date properly for PostgreSQL
                const dobValue = document.getElementById('dob').value;
                const formattedDob = dobValue ? new Date(dobValue).toISOString().split('T')[0] : null;
                
                // Create a clean object with only the fields we want to update
                const formData = {
                    id: user.id,
                    full_name: document.getElementById('full-name').value || null,
                    phone: document.getElementById('phone').value || null,
                    dob: formattedDob,
                    address: document.getElementById('address').value || null,
                    emergency_contact: document.getElementById('emergency-contact').value || null,
                    blood_group: document.getElementById('blood-group').value || null,
                    medical_conditions: document.getElementById('medical-conditions').value || null
                };
                
                console.log('Updating profile with data:', formData);
                
                // Try update first, then insert if update fails
                const { data: updateData, error: updateError } = await supabase
                    .from('profiles')
                    .update(formData)
                    .eq('id', user.id);
                
                if (updateError) {
                    console.error('Update error:', updateError);
                    
                    // If update fails, try insert
                    const { data: insertData, error: insertError } = await supabase
                        .from('profiles')
                        .insert([formData]);
                    
                    if (insertError) {
                        console.error('Insert error:', insertError);
                        
                        // If both update and insert fail, try a direct SQL query
                        try {
                            const { data: sqlData, error: sqlError } = await supabase.rpc(
                                'update_user_profile',
                                {
                                    p_user_id: user.id,
                                    p_full_name: formData.full_name,
                                    p_phone: formData.phone,
                                    p_dob: formData.dob,
                                    p_address: formData.address,
                                    p_emergency_contact: formData.emergency_contact,
                                    p_blood_group: formData.blood_group,
                                    p_medical_conditions: formData.medical_conditions
                                }
                            );
                            
                            if (sqlError) {
                                console.error('SQL error:', sqlError);
                                throw sqlError;
                            }
                        } catch (sqlError) {
                            console.error('SQL execution error:', sqlError);
                            throw sqlError;
                        }
                    }
                }
                
                alert('Your profile has been updated successfully!');
                window.location.href = 'dashboard.html';
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('Unable to update your profile. Error: ' + error.message);
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await supabase.auth.signOut();
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        }
    </script>
</body>
</html> 